<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integration Test - Dividend Update System</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .section h2 {
            margin-top: 0;
            color: #555;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            margin: 5px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        
        .btn:hover {
            background: #5a6fd8;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .code {
            background: #1e1e1e;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            overflow-x: auto;
        }
        
        .url-example {
            word-break: break-all;
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
        }
        
        .step {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-left: 4px solid #667eea;
            border-radius: 0 6px 6px 0;
        }
        
        .step h3 {
            margin-top: 0;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Dividend Update System Integration Test</h1>
        
        <!-- System Overview -->
        <div class="section">
            <h2>üèóÔ∏è System Architecture</h2>
            <div class="step">
                <h3>1. Google Sheets Setup</h3>
                <p>Add the <code>DashboardTrigger.gs</code> script to your Google Apps Script project</p>
                <button class="btn" onclick="window.open('https://script.google.com/create', '_blank')">Open Apps Script</button>
            </div>
            
            <div class="step">
                <h3>2. Sheet Configuration</h3>
                <p>Prepare your Google Sheet with ticker symbols in column A</p>
                <div class="code">
A1: Ticker    B1: Last Updated
A2: AAPL      
A3: MSFT      
A4: GOOGL     
A5: TSLA      </div>
            </div>
            
            <div class="step">
                <h3>3. Trigger Activation</h3>
                <p>Enter "UPDATE_DIVIDENDS" in cell A1 to open the update dashboard</p>
            </div>
        </div>
        
        <!-- Direct Testing -->
        <div class="section">
            <h2>üß™ Direct Testing</h2>
            <p>Test the update dashboard directly with sample data:</p>
            
            <div class="step">
                <h3>Full Historical Update (New User)</h3>
                <p>Simulates a user with no previous dividend data</p>
                <button class="btn" onclick="testFullUpdate()">Test Full Update</button>
            </div>
            
            <div class="step">
                <h3>Incremental Update (Existing User)</h3>
                <p>Simulates a user with existing data checking for updates</p>
                <button class="btn" onclick="testIncrementalUpdate()">Test Incremental Update</button>
            </div>
            
            <div class="step">
                <h3>Multi-User API Keys</h3>
                <p>Test different API keys for multi-tenant support</p>
                <button class="btn btn-secondary" onclick="testDemoUser()">Demo User</button>
                <button class="btn btn-secondary" onclick="testUser1()">User 1</button>
                <button class="btn btn-secondary" onclick="testUser2()">User 2</button>
            </div>
        </div>
        
        <!-- API Testing -->
        <div class="section">
            <h2>‚ö° API Endpoint Testing</h2>
            
            <div class="step">
                <h3>Check Update Status</h3>
                <p>Test the checkOnly feature for determining update requirements</p>
                <button class="btn" onclick="testCheckOnly()">Check AAPL Status</button>
                <div id="checkResult" style="margin-top: 10px;"></div>
            </div>
            
            <div class="step">
                <h3>Dividend Data Retrieval</h3>
                <p>Test fetching dividend data with fallback</p>
                <button class="btn" onclick="testDividendData()">Get AAPL Dividends</button>
                <div id="dividendResult" style="margin-top: 10px;"></div>
            </div>
        </div>
        
        <!-- URL Examples -->
        <div class="section">
            <h2>üîó Example URLs</h2>
            <p>These are the URLs that would be generated by the Google Apps Script:</p>
            
            <div class="step">
                <h3>Full Historical Update URL</h3>
                <div class="url-example" id="fullUpdateUrl"></div>
            </div>
            
            <div class="step">
                <h3>Incremental Update URL</h3>
                <div class="url-example" id="incrementalUpdateUrl"></div>
            </div>
        </div>
        
        <!-- Setup Instructions -->
        <div class="section">
            <h2>üìã Setup Checklist</h2>
            <div class="step">
                <h3>‚úÖ Prerequisites</h3>
                <ul>
                    <li>‚úÖ Update dashboard HTML created</li>
                    <li>‚úÖ Google Apps Script integration ready</li>
                    <li>‚úÖ API endpoints support checkOnly parameter</li>
                    <li>‚úÖ Multi-user API key structure implemented</li>
                </ul>
            </div>
            
            <div class="step">
                <h3>üöÄ Deployment Steps</h3>
                <ol>
                    <li>Deploy the public HTML files to your server</li>
                    <li>Copy DashboardTrigger.gs to your Google Apps Script</li>
                    <li>Update the URLs in the Apps Script configuration</li>
                    <li>Run completeSetup() in Apps Script</li>
                    <li>Test the integration using the buttons above</li>
                </ol>
            </div>
        </div>
    </div>
    
    <script>
        const BASE_URL = window.location.origin;
        const SAMPLE_TICKERS = ['AAPL', 'MSFT', 'GOOGL', 'TSLA', 'AMZN'];
        
        // Generate example URLs
        function generateExampleUrls() {
            const fullParams = new URLSearchParams({
                tickers: JSON.stringify(SAMPLE_TICKERS),
                apiKey: 'tk_demo_key_12345',
                user: btoa('test@example.com'),
                session: Date.now().toString()
            });
            
            const incrementalParams = new URLSearchParams({
                tickers: JSON.stringify(['AAPL', 'TSLA']), // Only 2 need updates
                apiKey: 'tk_demo_key_12345',
                lastUpdated: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                user: btoa('test@example.com'),
                session: Date.now().toString()
            });
            
            document.getElementById('fullUpdateUrl').textContent = 
                `${BASE_URL}/update-dashboard.html?${fullParams.toString()}`;
                
            document.getElementById('incrementalUpdateUrl').textContent = 
                `${BASE_URL}/update-dashboard.html?${incrementalParams.toString()}`;
        }
        
        // Test functions
        function testFullUpdate() {
            const params = new URLSearchParams({
                tickers: JSON.stringify(SAMPLE_TICKERS),
                apiKey: 'tk_demo_key_12345',
                user: btoa('test@example.com'),
                session: Date.now().toString()
            });
            
            const url = `${BASE_URL}/update-dashboard.html?${params.toString()}`;
            window.open(url, '_blank', 'width=1200,height=800');
        }
        
        function testIncrementalUpdate() {
            const params = new URLSearchParams({
                tickers: JSON.stringify(SAMPLE_TICKERS),
                apiKey: 'tk_demo_key_12345',
                lastUpdated: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                user: btoa('test@example.com'),
                session: Date.now().toString()
            });
            
            const url = `${BASE_URL}/update-dashboard.html?${params.toString()}`;
            window.open(url, '_blank', 'width=1200,height=800');
        }
        
        function testDemoUser() {
            testWithApiKey('tk_demo_key_12345', 'Demo User');
        }
        
        function testUser1() {
            testWithApiKey('tk_user1_api_key_67890', 'User 1');
        }
        
        function testUser2() {
            testWithApiKey('tk_user2_api_key_abcde', 'User 2');
        }
        
        function testWithApiKey(apiKey, userName) {
            const params = new URLSearchParams({
                tickers: JSON.stringify(['AAPL', 'MSFT', 'GOOGL']),
                apiKey: apiKey,
                user: btoa(`${userName.toLowerCase().replace(' ', '')}@example.com`),
                session: Date.now().toString()
            });
            
            const url = `${BASE_URL}/update-dashboard.html?${params.toString()}`;
            window.open(url, '_blank', 'width=1200,height=800');
        }
        
        async function testCheckOnly() {
            const resultDiv = document.getElementById('checkResult');
            resultDiv.innerHTML = '<em>Checking...</em>';
            
            try {
                const response = await fetch(`${BASE_URL}/api/dividends/AAPL?checkOnly=true`, {
                    headers: { 'X-API-Key': 'tk_demo_key_12345' }
                });
                
                const data = await response.json();
                resultDiv.innerHTML = `
                    <div class="code">
                        <strong>Status:</strong> ${data.needsUpdate ? 'Needs Update' : 'Up to Date'}<br>
                        <strong>Reason:</strong> ${data.reason}<br>
                        <strong>Last Dividend:</strong> ${data.lastDividendDate || 'None'}<br>
                        <strong>Days Since Update:</strong> ${data.daysSinceLastUpdate || 'N/A'}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div style="color: red;">Error: ${error.message}</div>`;
            }
        }
        
        async function testDividendData() {
            const resultDiv = document.getElementById('dividendResult');
            resultDiv.innerHTML = '<em>Fetching...</em>';
            
            try {
                const response = await fetch(`${BASE_URL}/api/dividends/AAPL?fallback=true`, {
                    headers: { 'X-API-Key': 'tk_demo_key_12345' }
                });
                
                const data = await response.json();
                resultDiv.innerHTML = `
                    <div class="code">
                        <strong>Ticker:</strong> ${data.ticker}<br>
                        <strong>Records:</strong> ${data.totalRecords}<br>
                        <strong>Source:</strong> ${data.dataSource}<br>
                        <strong>Sample Dividend:</strong><br>
                        Ex-Date: ${data.dividends[0]?.exDividendDate}<br>
                        Amount: $${data.dividends[0]?.amount}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div style="color: red;">Error: ${error.message}</div>`;
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            generateExampleUrls();
        });
    </script>
</body>
</html>